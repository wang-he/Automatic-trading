import ccxt
import time
import datetime
import pandas as pd

# ====== é…ç½®éƒ¨åˆ† ======
api_key = 'hide'
api_secret = 'hide'

symbol = 'BTC/USDT'
amount = 0.001
timeframe = '5m'
rsi_period = 14
rsi_buy = 30
rsi_sell = 70

# ====== è¿æ¥äº¤æ˜“æ‰€ ======
exchange = ccxt.binance({
    'apiKey': api_key,
    'secret': api_secret,
    'enableRateLimit': True
})

def fetch_ohlcv():
    data = exchange.fetch_ohlcv(symbol, timeframe=timeframe, limit=rsi_period + 1)
    df = pd.DataFrame(data, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
    return df

def calculate_rsi(df):
    delta = df['close'].diff()
    gain = delta.clip(lower=0).rolling(rsi_period).mean()
    loss = -delta.clip(upper=0).rolling(rsi_period).mean()
    rs = gain / loss
    rsi = 100 - 100 / (1 + rs)
    return rsi.iloc[-1]

def log(msg):
    now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    print(f"[{now}] {msg}")

# ====== ä¸»å¾ªç¯ ======
def run_bot():
    while True:
        try:
            df = fetch_ohlcv()
            if df.empty:
                log("æœªè·å–åˆ°Kçº¿æ•°æ®")
                continue

            rsi = calculate_rsi(df)
            log(f"å½“å‰ RSI: {rsi:.2f}")

            balance = exchange.fetch_balance()
            usdt = balance['free'].get('USDT', 0)
            btc = balance['free'].get('BTC', 0)

            log(f"è´¦æˆ·ä½™é¢ï¼šUSDT={usdt:.2f}, BTC={btc:.6f}")

            if rsi < rsi_buy and usdt > 10:
                order = exchange.create_market_buy_order(symbol, amount)
                log(f"ğŸ’° ä¹°å…¥æˆåŠŸï¼š{order}")

            elif rsi > rsi_sell and btc >= amount:
                order = exchange.create_market_sell_order(symbol, amount)
                log(f"ğŸš¨ å–å‡ºæˆåŠŸï¼š{order}")

        except Exception as e:
            log(f"âŒ é”™è¯¯ï¼š{e}")

        time.sleep(60)

# å¯åŠ¨æœºå™¨äºº
run_bot()
